<div class="orders-page">
  <header class="page-header shadow-card">
    <div>
      <p class="eyebrow">Quản lý đơn hàng</p>
      <h1>Đơn hàng & điểm danh</h1>
      <div class="header-actions">
        <button type="button" class="btn-primary" (click)="startCreate()" [disabled]="isEditing()">+ Thêm đơn hàng</button>
        <button type="button" class="btn-ghost" (click)="reload()" [disabled]="isEditing()">Làm mới</button>
        <button type="button" class="btn-ghost" disabled title="Sắp ra mắt">Tải CSV</button>
      </div>
    </div>
    <div class="header-stats">
      <span class="pill blue">Tổng: {{ orders().length }}</span>
      <span class="pill amber">Đang hiển thị: {{ filtered().length }}</span>
    </div>
  </header>

  <section class="filter-bar shadow-card">
    <div class="filter-field">
      <label>Từ khóa</label>
      <input placeholder="Tìm học sinh, phụ huynh hoặc sale" [ngModel]="keyword()" (ngModelChange)="keyword.set($event)" />
    </div>
    <div class="filter-field">
      <label>Giáo viên</label>
      <select [ngModel]="teacherFilter()" (ngModelChange)="teacherFilter.set($event)">
        <option value="">Tất cả</option>
        <option *ngFor="let teacher of teachers()" [value]="teacher._id">{{ teacher.fullName }}</option>
      </select>
    </div>
    <div class="filter-field">
      <label>Lớp học</label>
      <select [ngModel]="classFilter()" (ngModelChange)="classFilter.set($event)">
        <option value="">Tất cả</option>
        <option *ngFor="let classroom of classes()" [value]="classroom._id">{{ classroom.code }} - {{ classroom.name }}</option>
      </select>
    </div>
    <div class="filter-field">
      <label>Loại học sinh</label>
      <select [ngModel]="studentTypeFilter()" (ngModelChange)="studentTypeFilter.set($event)">
        <option value="">Tất cả</option>
        <option value="ONLINE">Online</option>
        <option value="OFFLINE">Offline</option>
      </select>
    </div>
    <div class="filter-field">
      <label>Sale</label>
      <select [ngModel]="saleFilter()" (ngModelChange)="saleFilter.set($event)">
        <option value="">Tất cả</option>
        <option *ngFor="let sale of sales()" [value]="sale._id">{{ sale.fullName }}</option>
      </select>
    </div>
    <div class="filter-field">
      <label>Tháng sinh</label>
      <select [ngModel]="birthMonthFilter()" (ngModelChange)="birthMonthFilter.set($event)">
        <option value="">Tất cả</option>
        <option *ngFor="let m of [1,2,3,4,5,6,7,8,9,10,11,12]" [value]="m">Tháng {{ m }}</option>
      </select>
    </div>
    <div class="filter-actions">
      <button type="button" class="btn-ghost" (click)="resetFilters()">Đặt lại</button>
    </div>
  </section>

  <section class="table-panel shadow-card">
    <ng-container *ngIf="filtered().length || isCreating(); else empty">
      <div class="table-scroll">
        <table class="orders-table">
          <thead>
            <tr>
              <th class="sticky-col">Mã HS</th>
              <th>Loại HS</th>
              <th class="col-student sticky-col">Tên HS</th>
              <th>Tên PH</th>
              <th>Điện thoại</th>
              <th>Level</th>
              <th>Ngày sinh</th>
              <th>Tuổi</th>
              <th>Sale</th>
              <th>Mã lớp</th>
              <th>Tên lớp</th>
              <th>Mã GV trong lớp</th>
              <th>GV + lương</th>
              <th>Số hóa đơn</th>
              <th class="col-sessions">Quỹ buổi</th>
              <th>Tình trạng HS</th>
              <th>Học thử/Buổi tặng</th>
              <th>Nhóm buổi</th>
              <th *ngFor="let col of sessionColumns">Buổi {{ col }}</th>
              <th>Tổng số buổi học đã điểm danh</th>
              <th>Trạng thái</th>
              <th class="sticky-col-right">Hành động</th>
            </tr>
          </thead>
          <tbody>
            <ng-container *ngIf="isCreating()">
              <ng-container *ngTemplateOutlet="editRow; context: { order: null, isNew: true }"></ng-container>
            </ng-container>
            <ng-container *ngFor="let order of filtered()">
              <ng-container *ngIf="isEditing(order._id); else viewRow">
                <ng-container *ngTemplateOutlet="editRow; context: { order: order, isNew: false }"></ng-container>
              </ng-container>
              <ng-template #viewRow>
                <ng-container *ngFor="let chunk of sessionChunks(order); let chunkIndex = index">
                  <tr>
                    <td *ngIf="chunkIndex === 0" class="cell code sticky-col" [attr.rowspan]="sessionChunks(order).length">{{ order.studentCode }}</td>
                    <td *ngIf="chunkIndex === 0" class="cell type" [attr.rowspan]="sessionChunks(order).length">{{ studentTypeLabel(order) }}</td>
                    <td *ngIf="chunkIndex === 0" class="cell student sticky-col" [attr.rowspan]="sessionChunks(order).length">{{ order.studentName }}</td>
                    <td *ngIf="chunkIndex === 0" class="cell parent" [attr.rowspan]="sessionChunks(order).length">{{ order.parentName }}</td>
                    <td *ngIf="chunkIndex === 0" class="cell phone" [attr.rowspan]="sessionChunks(order).length">{{ studentPhone(order) }}</td>
                    <td *ngIf="chunkIndex === 0" class="cell level" [attr.rowspan]="sessionChunks(order).length">{{ studentLevel(order) }}</td>
                    <td *ngIf="chunkIndex === 0" class="cell dob" [attr.rowspan]="sessionChunks(order).length">{{ studentDob(order) }}</td>
                    <td *ngIf="chunkIndex === 0" class="cell age" [attr.rowspan]="sessionChunks(order).length">{{ studentAge(order) }}</td>
                    <td *ngIf="chunkIndex === 0" class="cell sale" [attr.rowspan]="sessionChunks(order).length">{{ order.saleName || studentSale(order) || '-' }}</td>
                    <td *ngIf="chunkIndex === 0" class="cell class-code" [attr.rowspan]="sessionChunks(order).length">{{ order.classCode || '-' }}</td>
                    <td *ngIf="chunkIndex === 0" class="cell class-name" [attr.rowspan]="sessionChunks(order).length">{{ className(order) }}</td>
                    <td *ngIf="chunkIndex === 0" class="cell teacher-code-list" [attr.rowspan]="sessionChunks(order).length">{{ formatTeacherCodes(order) }}</td>
                    <td *ngIf="chunkIndex === 0" class="cell teacher-salary-list" [attr.rowspan]="sessionChunks(order).length">{{ formatTeacherNameSalary(order) }}</td>
                    <td *ngIf="chunkIndex === 0" class="cell invoice" [attr.rowspan]="sessionChunks(order).length">{{ order.invoiceNumber || '-' }}</td>
                    <td *ngIf="chunkIndex === 0" class="cell sessions" [attr.rowspan]="sessionChunks(order).length">
                      <div class="session-balance">
                        <div
                          class="session-line"
                          *ngFor="let line of sessionBalanceLines(order)"
                          [class.highlight]="line.highlight"
                        >
                          {{ line.text }}
                        </div>
                      </div>
                    </td>
                    <td *ngIf="chunkIndex === 0" class="cell data-status" [attr.rowspan]="sessionChunks(order).length">{{ studentStatus(order) }}</td>
                    <td *ngIf="chunkIndex === 0" class="cell gift" [attr.rowspan]="sessionChunks(order).length">{{ order.trialOrGift || '-' }}</td>
                    <td class="cell chunk-label">Buổi {{ chunk.start }} - {{ chunk.end }}</td>
                    <td *ngFor="let col of sessionColumns" class="cell session" [class.filled]="sessionCell(order, chunk.start + col - 1)?.attendedAt">
                      <ng-container *ngIf="sessionCell(order, chunk.start + col - 1) as session">
                        <ng-container *ngIf="session.attendedAt; else emptyCell">
                          <div class="session-details">
                            <div><span class="label">Mã điểm danh:</span><span>{{ generateAttendanceCode(order.studentCode, order.teacherCode, session.date, session.sessionIndex || (chunk.start + col - 1)) }}</span></div>
                            <div><span class="label">Học sinh:</span><span>{{ order.studentName }}</span></div>
                            <div><span class="label">Lớp:</span><span>{{ order.classCode || '-' }}</span></div>
                            <div><span class="label">Giáo viên:</span><span>{{ order.teacherName || '-' }}</span></div>
                            <div><span class="label">Thời lượng:</span><span>{{ session.sessionDuration || order.sessionDuration || '-' }} phút</span></div>
                            <div><span class="label">Ngày:</span><span>{{ formatDate(session.date) || '-' }}</span></div>
                            <div *ngIf="session.attendedAt"><span class="label">Điểm danh:</span><span>{{ formatDateTime(session.attendedAt) }}</span></div>
                          </div>
                          <div class="session-actions">
                            <a *ngIf="session.lookupUrl" [href]="session.lookupUrl" target="_blank">Xem</a>
                            <a *ngIf="session.imageUrl" [href]="session.imageUrl" target="_blank">Ảnh</a>
                          </div>
                        </ng-container>
                      </ng-container>
                    </td>
                    <td *ngIf="chunkIndex === 0" class="cell total-sessions" [attr.rowspan]="sessionChunks(order).length">{{ order.totalAttendedSessions ?? '-' }}</td>
                    <td *ngIf="chunkIndex === 0" class="cell status" [attr.rowspan]="sessionChunks(order).length" [class.active]="order.status === 'Đang hoạt động'" [class.locked]="order.status === 'Đã khóa'">{{ order.status || 'Đang hoạt động' }}</td>
                    <td *ngIf="chunkIndex === 0" class="cell actions sticky-col-right" [attr.rowspan]="sessionChunks(order).length">
                      <button *ngIf="order.status !== 'Đã khóa'" class="btn-ghost" (click)="startEdit(order)" [disabled]="isEditing()">Sửa</button>
                      <button *ngIf="order.status !== 'Đã khóa'" class="btn-ghost btn-danger" (click)="remove(order)" [disabled]="isEditing()">Xóa</button>
                      <span *ngIf="order.status === 'Đã khóa'" class="locked-message">Đã khóa</span>
                    </td>
                  </tr>
                </ng-container>
              </ng-template>
            </ng-container>
          </tbody>
        </table>
      </div>
    </ng-container>
  </section>

  <datalist id="studentCodeOptions">
    <option *ngFor="let student of students()" [value]="student.studentCode">{{ student.fullName }} - {{ student.parentPhone }}</option>
  </datalist>

  <datalist id="classCodeOptions">
    <option *ngFor="let classroom of classes()" [value]="classroom.code">{{ classroom.name }}</option>
  </datalist>

  <ng-template #empty>
    <div class="empty-state shadow-card">
      <p>Chưa có đơn hàng.</p>
      <button type="button" class="btn-primary" (click)="startCreate()" [disabled]="isEditing()">+ Tạo đơn đầu tiên</button>
    </div>
  </ng-template>

  <ng-template #emptyCell><span>-</span></ng-template>

  <ng-template #editRow let-order="order" let-isNew="isNew">
    <ng-container *ngFor="let chunk of sessionChunks(order || null); let chunkIndex = index">
      <tr>
        <td *ngIf="chunkIndex === 0" class="cell code editing sticky-col" [attr.rowspan]="sessionChunks(order || null).length">
          <input
            list="studentCodeOptions"
            placeholder="Chọn mã học sinh"
            [(ngModel)]="form.studentCode"
            (ngModelChange)="handleStudentCodeChange($event)"
            [ngModelOptions]="{ standalone: true }"
          />
        </td>
        <td *ngIf="chunkIndex === 0" class="cell type editing" [attr.rowspan]="sessionChunks(order || null).length">
          <select [(ngModel)]="form.studentType" [ngModelOptions]="{ standalone: true }">
            <option value="">-- Chọn loại --</option>
            <option value="ONLINE">Online</option>
            <option value="OFFLINE">Offline</option>
          </select>
        </td>
        <td *ngIf="chunkIndex === 0" class="cell student editing sticky-col" [attr.rowspan]="sessionChunks(order || null).length">
          <input placeholder="Tên học sinh" [(ngModel)]="form.studentName" [ngModelOptions]="{ standalone: true }" [disabled]="true" />
        </td>
        <td *ngIf="chunkIndex === 0" class="cell level editing" [attr.rowspan]="sessionChunks(order || null).length">
          <input [(ngModel)]="form.parentName" [ngModelOptions]="{ standalone: true }" [disabled]="true" />
        </td>
        <td *ngIf="chunkIndex === 0" class="cell phone editing" [attr.rowspan]="sessionChunks(order || null).length">
          <input [value]="studentPhone(order)" [disabled]="true" />
        </td>
        <td *ngIf="chunkIndex === 0" class="cell level editing" [attr.rowspan]="sessionChunks(order || null).length">
          <input placeholder="Nhập level" [(ngModel)]="form.level" [ngModelOptions]="{ standalone: true }" />
        </td>
        <td *ngIf="chunkIndex === 0" class="cell dob editing" [attr.rowspan]="sessionChunks(order || null).length">
          <input [value]="studentDob(order)" [disabled]="true" />
        </td>
        <td *ngIf="chunkIndex === 0" class="cell age editing" [attr.rowspan]="sessionChunks(order || null).length">
          <input [value]="studentAge(order)" [disabled]="true" />
        </td>
        <td *ngIf="chunkIndex === 0" class="cell sale editing" [attr.rowspan]="sessionChunks(order || null).length">
          <input placeholder="Tên sale" [(ngModel)]="form.saleName" [ngModelOptions]="{ standalone: true }" [disabled]="true" />
        </td>
        <td *ngIf="chunkIndex === 0" class="cell class-code editing" [attr.rowspan]="sessionChunks(order || null).length">
          <input
            list="classCodeOptions"
            placeholder="Chọn mã lớp"
            [(ngModel)]="form.classCode"
            (ngModelChange)="handleClassCodeChange($event)"
            [ngModelOptions]="{ standalone: true }"
          />
        </td>
        <td *ngIf="chunkIndex === 0" class="cell class-name editing" [attr.rowspan]="sessionChunks(order || null).length">
          <input [value]="className(order, form.classCode, form.classId)" [disabled]="true" />
        </td>
        <td *ngIf="chunkIndex === 0" class="cell teacher-code-list editing" [attr.rowspan]="sessionChunks(order || null).length">
          <input [value]="formatTeacherCodes(order, form.classCode, form.classId)" [disabled]="true" />
        </td>
        <td *ngIf="chunkIndex === 0" class="cell teacher-salary-list editing" [attr.rowspan]="sessionChunks(order || null).length">
          <input [value]="formatTeacherNameSalary(order, form.classCode, form.classId)" [disabled]="true" />
        </td>
        <td *ngIf="chunkIndex === 0" class="cell invoice editing" [attr.rowspan]="sessionChunks(order || null).length">
          <select [(ngModel)]="form.invoiceNumber" (ngModelChange)="handleInvoiceChange($event)" [ngModelOptions]="{ standalone: true }">
            <option value="">-- Chọn hóa đơn --</option>
            <option *ngFor="let invoice of availableInvoices()" [value]="invoice.code">{{ invoice.code }}</option>
          </select>
        </td>
        <td *ngIf="chunkIndex === 0" class="cell sessions editing" [attr.rowspan]="sessionChunks(order || null).length">
          <div class="session-balance">
            <div
              class="session-line"
              *ngFor="let line of sessionBalanceLines(order)"
              [class.highlight]="line.highlight"
            >
              {{ line.text }}
            </div>
          </div>
        </td>
        <td *ngIf="chunkIndex === 0" class="cell data-status editing" [attr.rowspan]="sessionChunks(order || null).length">
          <select [(ngModel)]="form.dataStatus" [ngModelOptions]="{ standalone: true }">
            <option value="">-- Chọn tình trạng --</option>
            <option value="Đang học">Đang học</option>
            <option value="Bảo lưu">Bảo lưu</option>
            <option value="Kết thúc">Kết thúc</option>
          </select>
        </td>
        <td *ngIf="chunkIndex === 0" class="cell gift editing" [attr.rowspan]="sessionChunks(order || null).length">
          <input [(ngModel)]="form.trialOrGift" [ngModelOptions]="{ standalone: true }" />
        </td>
        <td class="cell chunk-label">Buổi {{ chunk.start }} - {{ chunk.end }}</td>
        <td *ngFor="let col of sessionColumns" class="cell session editing" [class.filled]="sessionCell(order, chunk.start + col - 1)?.attendedAt">
          <ng-container *ngIf="sessionCell(order, chunk.start + col - 1) as session">
            <ng-container *ngIf="session.attendedAt; else emptyCell">
              <div class="session-details">
                <div><span class="label">Mã điểm danh:</span><span>{{ generateAttendanceCode(form.studentCode || order?.studentCode, form.teacherCode || order?.teacherCode, session.date, session.sessionIndex || (chunk.start + col - 1)) }}</span></div>
                <div><span class="label">Học sinh:</span><span>{{ form.studentName || order?.studentName }}</span></div>
                <div><span class="label">Lớp:</span><span>{{ form.classCode || order?.classCode || '-' }}</span></div>
                <div><span class="label">Giáo viên:</span><span>{{ form.teacherName || order?.teacherName || '-' }}</span></div>
                <div><span class="label">Ngày:</span><span>{{ formatDate(session.date) || '-' }}</span></div>
                <div *ngIf="session.attendedAt"><span class="label">Điểm danh:</span><span>{{ formatDateTime(session.attendedAt) }}</span></div>
              </div>
              <div class="session-actions">
                <a *ngIf="session.lookupUrl" [href]="session.lookupUrl" target="_blank">Xem</a>
                <a *ngIf="session.imageUrl" [href]="session.imageUrl" target="_blank">Ảnh</a>
              </div>
            </ng-container>
          </ng-container>
        </td>
        <td *ngIf="chunkIndex === 0" class="cell total-sessions editing" [attr.rowspan]="sessionChunks(order || null).length">
          <span>{{ order?.totalAttendedSessions ?? '-' }}</span>
        </td>
        <td *ngIf="chunkIndex === 0" class="cell status editing" [attr.rowspan]="sessionChunks(order || null).length">
          <select [(ngModel)]="form.status" [ngModelOptions]="{ standalone: true }">
            <option value="Đang hoạt động">Đang hoạt động</option>
            <option value="Đã khóa">Đã khóa</option>
          </select>
        </td>
        <td *ngIf="chunkIndex === 0" class="cell actions editing sticky-col-right" [attr.rowspan]="sessionChunks(order || null).length">
          <button class="btn-primary" type="button" (click)="save()">{{ isNew ? 'Tạo đơn' : 'Lưu' }}</button>
          <button class="btn-ghost" type="button" (click)="cancel()">Hủy</button>
          <div class="error" *ngIf="error()">{{ error() }}</div>
        </td>
      </tr>
    </ng-container>
  </ng-template>
</div>
